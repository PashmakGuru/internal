name: Bootstrap Terraform Cloud
on: workflow_dispatch

env:
  TOKEN: ${{ secrets.TFC_API_TOKEN }}
  ORG_NAME: ${{ vars.TFC_ORGANIZATION }}
  ORG_EMAIL: nasiri.amirreza.96@gmail.com
  PROJECT_NAME: remote-operations
  WORKSPACE_NAME: remote-operations-prod
  WORKSPACE_EXECUTION: remote
  WORKSPACE_DESCRIPTION: This workspace is bootstrapped via idempotent GH workflow (bootstrap-terraform-cloud.yaml). It enables us to perform remote operations on TFC and synchronize its resources.

jobs:
  bootstrap-tfe:
    name: Bootstrap Terraform Cloud
    runs-on: ubuntu-22.04
    steps:
    - name: Bootstrap Organization and Workspace
      run: |
        # üè¢ Check if the organization exists
        if curl -f -o /dev/null -s --head --request GET \
            --header "Authorization: Bearer ${{ env.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORG_NAME }}/workspaces; then
            echo "üè¢ Organization exists."
        else
            echo "üè¢ Organization does not exist. Creating..."
            curl -X POST \
                --fail \
                --header "Authorization: Bearer ${{ env.TOKEN }}" \
                --header "Content-Type: application/vnd.api+json" \
                https://app.terraform.io/api/v2/organizations \
                --data @- << REQUEST_BODY
        {
            "data": {
                "type": "organizations",
                "attributes": {
                    "name": "${{ env.ORG_NAME }}",
                    "email": "${{ env.ORG_EMAIL }}"
                }
            }
        }
        REQUEST_BODY
        fi

        # üíº Check if the project exists
        PROJECTS=$(curl \
            --header "Authorization: Bearer ${{ env.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORG_NAME }}/projects)

        if curl -f -o /dev/null -s --head --request GET \
            --header "Authorization: Bearer ${{ env.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORG_NAME }}/projects/${{ env.PROJECT_NAME }}; then
            echo "üíº Project exists."
        else
            echo "üíº Project does not exist. Creating..."
            curl -X POST \
                --fail \
                --header "Authorization: Bearer ${{ env.TOKEN }}" \
                --header "Content-Type: application/vnd.api+json" \
                https://app.terraform.io/api/v2/organizations/${{ env.ORG_NAME }}/projects \
                --data @- << REQUEST_BODY
        {
            "data": {
                "attributes": {
                    "name": "${{ env.PROJECT_NAME }}"
                },
                "type": "projects"
            }
        }
        REQUEST_BODY
        fi

        # üìã Check if the workspace exists
        if curl -f -o /dev/null -s --head --request GET \
            --header "Authorization: Bearer ${{ env.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORG_NAME }}/workspaces/${{ env.WORKSPACE_NAME }}; then
            echo "üìã Workspace exists."
        else
            echo "üìã Workspace does not exist. Creating..."
            curl -X POST \
                --fail \
                --header "Authorization: Bearer ${{ env.TOKEN }}" \
                --header "Content-Type: application/vnd.api+json" \
                https://app.terraform.io/api/v2/organizations/${{ env.ORG_NAME }}/workspaces \
                --data @- << REQUEST_BODY
        {
            "data": {
            "attributes": {
                "name": "${{ env.WORKSPACE_NAME }}",
                "execution-mode": "${{ env.WORKSPACE_EXECUTION }}",
                "description": "${{ env.WORKSPACE_DESCRIPTION }}"
            },
            "type": "workspaces"
            }
        }
        REQUEST_BODY
        fi
