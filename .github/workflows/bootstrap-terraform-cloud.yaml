name: Bootstrap Terraform Cloud
on: workflow_dispatch

env:
  TOKEN: ${{ secrets.TFC_API_TOKEN }}
  ORGAN_NAME: ${{ vars.TFC_ORGANIZATION }}
  WORKSPACE_NAME: internal

jobs:
  bootstrap-tfe:
    name: Bootstrap Terraform Cloud
    runs-on: ubuntu-22.04
    steps:
    - name: Bootstrap Organization and Workspace
      run: |
        # Check if the organization exists
        if curl -f -o /dev/null -s --head --request GET \
            --header "Authorization: Bearer ${{ secrets.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORGAN_NAME }}/workspaces; then
            echo "Organization exists."
        else
            echo "Organization does not exist. Creating..."
            curl -X POST \
            --header "Authorization: Bearer ${{ secrets.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations \
            --data @- << REQUEST_BODY
        {
            "data": {
            "type": "organizations",
            "attributes": {
                "name": "${{ env.ORGAN_NAME }}",
                "email": "${{ secrets.ADMIN_EMAIL }}"
            }
            }
        }
        REQUEST_BODY
        fi

        # Check if the workspace exists
        if curl -f -o /dev/null -s --head --request GET \
            --header "Authorization: Bearer ${{ secrets.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORGAN_NAME }}/workspaces/${{ env.WORKSPACE_NAME }}; then
            echo "Workspace exists."
        else
            echo "Workspace does not exist. Creating..."
            curl -X POST \
            --header "Authorization: Bearer ${{ secrets.TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            https://app.terraform.io/api/v2/organizations/${{ env.ORGAN_NAME }}/workspaces \
            --data @- << REQUEST_BODY
        {
            "data": {
            "attributes": {
                "name": "${{ env.WORKSPACE_NAME }}",
                "execution-mode": "remote"
            },
            "type": "workspaces"
            }
        }
        REQUEST_BODY
        fi
